<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" type="text/css" href="style.css" />
    <link rel="stylesheet" type="text/css" href="print.css" />
    <meta charset="utf-8" />
    <link href="https://fonts.cdnfonts.com/css/prompt" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/monday-sdk-js/dist/main.js"></script>
    <script src="https://code.jquery.com/jquery-1.12.3.min.js"></script>
    <script src="jquery.printelement.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jQuery.print/1.6.2/jQuery.print.min.js"></script>
    <script src="https://kit.fontawesome.com/a076d05399.js"></script>
    <style>
    #print_btn {
        position: absolute;
        transform: scale(1.2);
        top: 20px;
        left: 20px;
    }
    .page {
        page-break-after: always;
    }
    </style>
</head>

<body>
    <button id="print_btn">列 印</button>
    <div id='print_box'>
        <div id="title">
            <h2 id='title_text' class='not_select'>請設定標題</h2>
            <h3 id='subTitle' class='not_select'>請設定副標題</h3>
        </div>
        <div id='content'></div>
    </div>
    <script>
    function getParameterByName(name, url) {
        if (!url) url = window.location.href;
        name = name.replace(/[[\]]/g, '\\$&');
        var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
            results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, ' '));
    }

    let columnNum = parseInt(getParameterByName('columnNum')) || 2;
    let allImg = getParameterByName('iurl')
    allImg = allImg ? allImg.split(',') : [];
    let infoData = getParameterByName('data')
    let layoutDirection = getParameterByName('layoutDirection') || 'vertical';

    // 切換 body class 以配合列印方向
    if (layoutDirection === 'vertical') {
        document.body.classList.add('portrait');
        document.body.classList.remove('landscape');
    } else {
        document.body.classList.add('landscape');
        document.body.classList.remove('portrait');
    }

    // 動態產生圖片分頁
    function renderImages() {
        const content = document.getElementById('content');
        content.innerHTML = '';
        // A4尺寸（mm），需轉換為 px，假設 1mm = 3.78px
        const mm2px = mm => mm * 3.78;
        const a4w = layoutDirection === 'vertical' ? mm2px(210) : mm2px(297);
        const a4h = layoutDirection === 'vertical' ? mm2px(297) : mm2px(210);
        const colNum = columnNum;
        const rowHeight = layoutDirection === 'vertical' ? mm2px(120) : mm2px(80); // 直式每行高度、橫式每行高度
        const imgPerRow = colNum;
        const rowsPerPage = Math.floor(a4h / rowHeight);
        const imgsPerPage = imgPerRow * rowsPerPage;
        let pageIdx = 0;
        for (let i = 0; i < allImg.length; i += imgsPerPage) {
            const pageDiv = document.createElement('div');
            pageDiv.className = 'page';
            // 直式時加旋轉
            if (layoutDirection === 'vertical') {
                pageDiv.classList.add('portrait-page');
            }
            for (let j = 0; j < imgsPerPage && (i + j) < allImg.length; j += imgPerRow) {
                const rowDiv = document.createElement('div');
                rowDiv.style.display = 'flex';
                rowDiv.style.flexDirection = 'row';
                rowDiv.style.width = '100%';
                for (let k = 0; k < imgPerRow && (i + j + k) < allImg.length; k++) {
                    const div = document.createElement('div');
                    const div2 = document.createElement('div');
                    const img = document.createElement('img');
                    div.id = 'img_div_' + (i + j + k);
                    img.id = 'img_' + (i + j + k);
                    div2.id = 'img_div2_' + (i + j + k);
                    div.className = 'item_img' + columnNum;
                    div2.className = 'image_box';
                    img.src = allImg[i + j + k];
                    img.className = 'image';
                    div.appendChild(div2);
                    div2.appendChild(img);
                    rowDiv.appendChild(div);
                }
                pageDiv.appendChild(rowDiv);
            }
            content.appendChild(pageDiv);
            pageIdx++;
        }
    }

    renderImages();

    document.getElementById('print_btn').onclick = function() {
        window.print();
    };
    </script>
</body>

</html>